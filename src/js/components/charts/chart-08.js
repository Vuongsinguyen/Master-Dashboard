import ApexCharts from "apexcharts";

// Time-based issue data
const timeData = {
  "heineken-vietnam-brewery": {
    "issues": [
      [
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        2,
        0,
        0,
        1,
        2,
        1,
        1,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        0
      ],
      [
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        2,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        2,
        1,
        2,
        1,
        0,
        0
      ],
      [
        0,
        2,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        1,
        1
      ],
      [
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        1,
        0,
        0
      ],
      [
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        1,
        2,
        1,
        0,
        0,
        1,
        0,
        1,
        1,
        0,
        0,
        1
      ],
      [
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        1,
        0,
        0,
        1,
        0,
        0,
        0
      ],
      [
        2,
        0,
        1,
        0,
        2,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        2,
        0
      ]
    ]
  },
  "ttc-group": {
    "issues": [
      [
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        1,
        0
      ],
      [
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        2,
        0,
        0,
        0,
        0
      ],
      [
        1,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        1
      ],
      [
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        2,
        0,
        1,
        2,
        0,
        0,
        1,
        0,
        3,
        0,
        0,
        0,
        1,
        2,
        0,
        0,
        0
      ],
      [
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        2
      ],
      [
        0,
        0,
        0,
        1,
        1,
        0,
        2,
        1,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        2,
        0
      ],
      [
        1,
        3,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        2,
        1,
        1,
        1,
        1,
        2,
        0,
        0
      ]
    ]
  },
  "moshi-moshi-ramen": {
    "issues": [
      [
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0
      ],
      [
        1,
        0,
        1,
        0,
        0,
        2,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        2,
        1
      ],
      [
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        1
      ],
      [
        1,
        1,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        3,
        0,
        2,
        1,
        0,
        1,
        0,
        0
      ],
      [
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        2,
        0,
        0,
        0,
        0,
        0,
        0
      ],
      [
        1,
        1,
        1,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0
      ],
      [
        1,
        0,
        0,
        0,
        2,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        2,
        0,
        0,
        0
      ]
    ]
  },
  "p2p-agency": {
    "issues": [
      [
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        1,
        2,
        0
      ],
      [
        0,
        0,
        2,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        2,
        0,
        1,
        1,
        0,
        0
      ],
      [
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0
      ],
      [
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        0
      ],
      [
        0,
        0,
        0,
        0,
        1,
        2,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        1,
        0
      ],
      [
        0,
        0,
        0,
        0,
        0,
        0,
        2,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        2,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0
      ],
      [
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        2
      ]
    ]
  },
  "e-picos": {
    "issues": [
      [
        1,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        1,
        1,
        1,
        0,
        0,
        0,
        0,
        0,
        1,
        2,
        1,
        0,
        0,
        1,
        0,
        0
      ],
      [
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        0,
        2,
        0,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        1
      ],
      [
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        1,
        1,
        1,
        1,
        0,
        2,
        0,
        0,
        1,
        1,
        0
      ],
      [
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        2,
        0,
        1,
        1,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0
      ],
      [
        2,
        0,
        2,
        0,
        1,
        0,
        1,
        1,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0
      ],
      [
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        2,
        0,
        0,
        0,
        1,
        1,
        0,
        1,
        0,
        0
      ],
      [
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0
      ]
    ]
  },
  "hung-thinh-land": {
    "issues": [
      [
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        1,
        1,
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        1,
        0,
        0,
        0,
        1,
        0
      ],
      [
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        0
      ],
      [
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        1,
        0,
        0,
        0
      ],
      [
        2,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        2,
        0,
        0,
        0,
        0,
        0,
        1
      ],
      [
        3,
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        2,
        1,
        0,
        0,
        1,
        0,
        1,
        1
      ],
      [
        1,
        0,
        0,
        0,
        0,
        2,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        2,
        0,
        1,
        2,
        0,
        1,
        0
      ],
      [
        0,
        0,
        0,
        1,
        0,
        0,
        2,
        2,
        1,
        1,
        0,
        2,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        2,
        0
      ]
    ]
  },
  "land-tsn-air": {
    "issues": [
      [
        1,
        0,
        0,
        0,
        0,
        1,
        1,
        1,
        0,
        0,
        0,
        2,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        2
      ],
      [
        0,
        0,
        0,
        0,
        0,
        2,
        1,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        2,
        1,
        0,
        0,
        0,
        0
      ],
      [
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        1
      ],
      [
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        1,
        1,
        0,
        0,
        1,
        0,
        0,
        2,
        0,
        0,
        0,
        0,
        2,
        0
      ],
      [
        0,
        0,
        1,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        0,
        0
      ],
      [
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        1,
        1,
        2,
        1,
        0,
        0
      ],
      [
        0,
        0,
        2,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        1,
        0,
        0,
        1,
        0,
        2,
        0,
        1,
        1,
        0,
        1,
        0,
        0,
        0
      ]
    ]
  },
  "hoan-my-hospital": {
    "issues": [
      [
        1,
        0,
        2,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        2,
        0,
        2,
        1,
        0,
        1,
        1
      ],
      [
        0,
        0,
        0,
        0,
        2,
        0,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        3,
        1,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        1
      ],
      [
        2,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        1,
        2,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1
      ],
      [
        0,
        0,
        0,
        1,
        0,
        2,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        1,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        1,
        0
      ],
      [
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        1,
        2,
        1,
        1,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        0
      ],
      [
        1,
        0,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0
      ],
      [
        0,
        0,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        0,
        2,
        1,
        0,
        0,
        1,
        1,
        2,
        0,
        0,
        0,
        1,
        1
      ]
    ]
  }
};







const chart08 = () => {
  let chartInstance;

  const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const hours = Array.from({length: 24}, (_, i) => i);

  function getSelectedCompanies() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:not(#select-all):not(.month-checkbox):not(#select-all-months)');
    return Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.nextSibling.textContent.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''));
  }

  function aggregateTimeData(companies) {
    const aggregated = Array(7).fill().map(() => Array(24).fill(0));

    companies.forEach(company => {
      const data = timeData[company];
      if (data && data.issues) {
        data.issues.forEach((dayData, dayIndex) => {
          dayData.forEach((hourValue, hourIndex) => {
            aggregated[dayIndex][hourIndex] += hourValue;
          });
        });
      }
    });

    return aggregated;
  }

  function findPeakTime(aggregated) {
    let maxValue = 0;
    let peakHour = 0;
    let peakDay = 0;

    aggregated.forEach((dayData, dayIndex) => {
      dayData.forEach((value, hourIndex) => {
        if (value > maxValue) {
          maxValue = value;
          peakHour = hourIndex;
          peakDay = dayIndex;
        }
      });
    });

    return {
      time: `${peakHour.toString().padStart(2, '0')}:00-${(peakHour + 1).toString().padStart(2, '0')}:00`,
      day: daysOfWeek[peakDay],
      value: maxValue
    };
  }

  function findBusiestDay(aggregated) {
    const dayTotals = aggregated.map(dayData => dayData.reduce((sum, val) => sum + val, 0));
    const maxIndex = dayTotals.indexOf(Math.max(...dayTotals));
    return daysOfWeek[maxIndex];
  }

  function updateKPIs(aggregated) {
    const peak = findPeakTime(aggregated);
    const busiestDay = findBusiestDay(aggregated);

    document.getElementById('peak-time').textContent = peak.time;
    document.getElementById('busiest-day').textContent = busiestDay;
    document.getElementById('staffing-tip').textContent = peak.value > 20 ? 'Add 3+ staff' : peak.value > 10 ? 'Add 2 staff' : 'Add 1 staff';
  }

  const initialCompanies = getSelectedCompanies();
  const initialData = aggregateTimeData(initialCompanies);

  // Prepare data for heatmap
  const series = [];
  initialData.forEach((dayData, dayIndex) => {
    dayData.forEach((value, hourIndex) => {
      series.push({
        x: `${hourIndex.toString().padStart(2, '0')}:00`,
        y: daysOfWeek[dayIndex],
        value: value
      });
    });
  });

  const chartEightOptions = {
    series: [{
      name: 'Issues',
      data: series
    }],
    chart: {
      fontFamily: "Outfit, sans-serif",
      type: "heatmap",
      height: 400,
      toolbar: {
        show: false,
      },
    },
    dataLabels: {
      enabled: false
    },
    colors: ["#e3f2fd", "#bbdefb", "#90caf9", "#64b5f6", "#42a5f5", "#2196f3", "#1e88e5", "#1976d2", "#1565c0", "#0d47a1"],
    xaxis: {
      type: 'category',
      categories: hours.map(h => `${h.toString().padStart(2, '0')}:00`),
      title: {
        text: 'Hour of Day'
      }
    },
    yaxis: {
      type: 'category',
      categories: daysOfWeek,
      title: {
        text: 'Day of Week'
      }
    },
    plotOptions: {
      heatmap: {
        shadeIntensity: 0.5,
        radius: 0,
        useFillColorAsStroke: true,
        colorScale: {
          ranges: [
            { from: 0, to: 0, color: '#f3f4f6', name: 'No Issues' },
            { from: 1, to: 5, color: '#dbeafe', name: 'Low' },
            { from: 6, to: 10, color: '#bfdbfe', name: 'Medium' },
            { from: 11, to: 15, color: '#93c5fd', name: 'High' },
            { from: 16, to: 20, color: '#60a5fa', name: 'Very High' },
            { from: 21, to: 30, color: '#3b82f6', name: 'Critical' },
            { from: 31, to: 50, color: '#1d4ed8', name: 'Extreme' }
          ]
        }
      }
    },
    tooltip: {
      y: {
        formatter: function (val) {
          return val;
        }
      }
    },
    legend: {
      show: true,
      position: 'bottom'
    }
  };

  const chartEight = new ApexCharts(document.querySelector("#chartEight"), chartEightOptions);
  chartEight.render();

  updateKPIs(initialData);

  // Listen for checkbox changes
  document.addEventListener('change', (e) => {
    if (e.target.type === 'checkbox' && !e.target.classList.contains('month-checkbox') && e.target.id !== 'select-all-months') {
      const companies = getSelectedCompanies();
      const aggregated = aggregateTimeData(companies);

      const newSeries = [];
      aggregated.forEach((dayData, dayIndex) => {
        dayData.forEach((value, hourIndex) => {
          newSeries.push({
            x: `${hourIndex.toString().padStart(2, '0')}:00`,
            y: daysOfWeek[dayIndex],
            value: value
          });
        });
      });

      chartEight.updateSeries([{
        name: 'Issues',
        data: newSeries
      }]);

      updateKPIs(aggregated);
    }
  });

  // Handle select all checkbox
  const selectAllCheckbox = document.getElementById('select-all');
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', () => {
      const companyCheckboxes = document.querySelectorAll('input[type="checkbox"]:not(#select-all):not(.month-checkbox):not(#select-all-months)');
      companyCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);

      const companies = getSelectedCompanies();
      const aggregated = aggregateTimeData(companies);

      const newSeries = [];
      aggregated.forEach((dayData, dayIndex) => {
        dayData.forEach((value, hourIndex) => {
          newSeries.push({
            x: `${hourIndex.toString().padStart(2, '0')}:00`,
            y: daysOfWeek[dayIndex],
            value: value
          });
        });
      });

      chartEight.updateSeries([{
        name: 'Issues',
        data: newSeries
      }]);

      updateKPIs(aggregated);
    });
  }
};

export default chart08;